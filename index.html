<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼¹å¹•å¢™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1f4b, #1f5f61, #4a1e6b, #1e3c72);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: white;
            font-family: 'Microsoft YaHei', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #danmu-container {
            width: 100%;
            height: 85vh;
            position: relative;
            border-bottom: 2px dashed rgba(255,255,255,0.3);
            overflow: hidden;
            background: rgba(0,0,0,0.1);
        }

        .danmu {
            position: absolute;
            white-space: nowrap;
            font-size: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: moveLeft 12s linear forwards;
            cursor: pointer;
            z-index: 1;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
        }

        .trouble { color: #48dbfb; }
        .wish { color: #feca57; }

        @keyframes moveLeft {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }

        .input-area {
            padding: 20px;
            text-align: center;
            height: 15vh;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        #danmu-type {
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: bold;
        }

        #danmu-input {
            padding: 10px 15px;
            width: 350px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
        }

        #send-btn {
            padding: 10px 25px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }

        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.6);
        }

        .status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .loading {
            text-align: center;
            padding-top: 50px;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .stats {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* === å¢å¼ºç‰ˆå¼¹å¹•ç‰¹æ•ˆæ ·å¼ === */
        .danmu.special {
            font-size: 24px !important;
            animation: specialMove 10s linear forwards;
            text-shadow: 
                0 0 10px currentColor,
                0 0 20px currentColor,
                0 0 30px currentColor;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            padding: 6px 16px;
            border: 2px solid currentColor;
        }
        
        .danmu.rainbow {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1, #a29bfe, #ff6b6b) !important;
            background-size: 400% 400%;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            color: transparent !important;
            animation: rainbowMove 8s linear infinite, moveLeft 10s linear forwards;
            font-size: 22px !important;
            /* æ·»åŠ é»‘è‰²æè¾¹ç¡®ä¿åœ¨ä»»ä½•èƒŒæ™¯ä¸‹éƒ½èƒ½çœ‹æ¸… */
            text-shadow: 
                1px 1px 2px rgba(0,0,0,0.8),
                -1px -1px 2px rgba(0,0,0,0.8),
                1px -1px 2px rgba(0,0,0,0.8),
                -1px 1px 2px rgba(0,0,0,0.8);
            padding: 5px 14px;
        }
        
        .danmu.shake {
            animation: shakeMove 10s linear forwards;
            color: #ff6b6b;
            font-size: 22px !important;
            text-shadow: 
                0 0 10px #ff6b6b,
                0 0 20px #ff6b6b;
        }
        
        .danmu.bounce {
            animation: bounceMove 9s linear forwards;
            color: #1dd1a1;
            font-size: 22px !important;
            text-shadow: 
                0 0 10px #1dd1a1,
                0 0 20px #1dd1a1;
        }
        
        .danmu.glowing {
            color: #feca57;
            animation: glowMove 10s linear forwards;
            font-size: 24px !important;
            text-shadow: 
                0 0 10px #feca57,
                0 0 20px #feca57,
                0 0 30px #feca57,
                0 0 40px #feca57;
            background: rgba(254,202,87,0.1);
            padding: 6px 16px;
            border-radius: 20px;
        }
        
        .danmu.ghost {
            opacity: 0.9;
            animation: ghostMove 14s linear forwards;
            color: #a29bfe;
            font-size: 21px !important;
            font-style: italic;
            text-shadow: 
                0 0 15px #a29bfe,
                0 0 30px #a29bfe;
            background: rgba(162,155,254,0.1);
            padding: 5px 14px;
            border-radius: 15px;
        }

        .danmu.fire {
            color: #ff6b6b;
            animation: fireMove 11s linear forwards;
            font-size: 23px !important;
            text-shadow: 
                0 0 10px #ff6b6b,
                0 0 20px #ff6b6b,
                0 0 30px #ff6b6b,
                0 0 40px #ff6b6b;
            background: linear-gradient(45deg, transparent, rgba(255,107,107,0.2), transparent);
            padding: 6px 16px;
        }

        .danmu.neon {
            color: #48dbfb;
            animation: neonMove 10s linear forwards;
            font-size: 22px !important;
            text-shadow: 
                0 0 5px #fff,
                0 0 10px #48dbfb,
                0 0 15px #48dbfb,
                0 0 20px #48dbfb;
            border: 2px solid #48dbfb;
            background: rgba(72,219,251,0.1);
            padding: 5px 14px;
            border-radius: 25px;
        }

        /* === å¢å¼ºç‰ˆå¼¹å¹•ç‰¹æ•ˆåŠ¨ç”» === */
        @keyframes specialMove {
            0% { 
                transform: translateX(100vw) scale(0.8) rotate(-5deg);
                opacity: 0;
            }
            10% { 
                transform: translateX(90vw) scale(1.5) rotate(5deg);
                opacity: 1;
            }
            30% { 
                transform: translateX(70vw) scale(1.2) rotate(-3deg);
            }
            50% { 
                transform: translateX(50vw) scale(1) rotate(2deg);
            }
            70% { 
                transform: translateX(30vw) scale(1.1) rotate(-1deg);
            }
            90% { 
                transform: translateX(10vw) scale(0.9) rotate(1deg);
            }
            100% { 
                transform: translateX(-100%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        @keyframes rainbowMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes shakeMove {
            0% { transform: translateX(100vw) rotate(0deg) translateY(0px); }
            5% { transform: translateX(95vw) rotate(-8deg) translateY(-10px); }
            10% { transform: translateX(90vw) rotate(8deg) translateY(10px); }
            15% { transform: translateX(85vw) rotate(-6deg) translateY(-8px); }
            20% { transform: translateX(80vw) rotate(6deg) translateY(8px); }
            25% { transform: translateX(75vw) rotate(-4deg) translateY(-6px); }
            30% { transform: translateX(70vw) rotate(4deg) translateY(6px); }
            35% { transform: translateX(65vw) rotate(-2deg) translateY(-4px); }
            40% { transform: translateX(60vw) rotate(2deg) translateY(4px); }
            45% { transform: translateX(55vw) rotate(-1deg) translateY(-2px); }
            50% { transform: translateX(50vw) rotate(0deg) translateY(0px); }
            55% { transform: translateX(45vw) rotate(1deg) translateY(2px); }
            60% { transform: translateX(40vw) rotate(-1deg) translateY(-2px); }
            65% { transform: translateX(35vw) rotate(1deg) translateY(2px); }
            70% { transform: translateX(30vw) rotate(-1deg) translateY(-2px); }
            75% { transform: translateX(25vw) rotate(1deg) translateY(2px); }
            80% { transform: translateX(20vw) rotate(-1deg) translateY(-2px); }
            85% { transform: translateX(15vw) rotate(1deg) translateY(2px); }
            90% { transform: translateX(10vw) rotate(-1deg) translateY(-2px); }
            95% { transform: translateX(5vw) rotate(1deg) translateY(2px); }
            100% { transform: translateX(-100%) rotate(0deg) translateY(0px); }
        }
        
        @keyframes bounceMove {
            0% { transform: translateX(100vw) translateY(0px); }
            10% { transform: translateX(90vw) translateY(-40px); }
            20% { transform: translateX(80vw) translateY(0px); }
            30% { transform: translateX(70vw) translateY(-30px); }
            40% { transform: translateX(60vw) translateY(0px); }
            50% { transform: translateX(50vw) translateY(-20px); }
            60% { transform: translateX(40vw) translateY(0px); }
            70% { transform: translateX(30vw) translateY(-15px); }
            80% { transform: translateX(20vw) translateY(0px); }
            90% { transform: translateX(10vw) translateY(-10px); }
            100% { transform: translateX(-100%) translateY(0px); }
        }
        
        @keyframes glowMove {
            0% { 
                transform: translateX(100vw);
                text-shadow: 0 0 5px currentColor;
            }
            20% { 
                text-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
            50% { 
                text-shadow: 0 0 30px currentColor, 0 0 50px currentColor, 0 0 60px currentColor;
            }
            80% { 
                text-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
            100% { 
                transform: translateX(-100%);
                text-shadow: 0 0 5px currentColor;
            }
        }
        
        @keyframes ghostMove {
            0% { 
                transform: translateX(100vw) scale(0.8);
                opacity: 0.3;
                filter: blur(2px);
            }
            20% { 
                opacity: 0.9;
                filter: blur(0px);
                transform: translateX(80vw) scale(1.1);
            }
            40% { 
                opacity: 0.6;
                filter: blur(1px);
            }
            60% { 
                opacity: 0.8;
                filter: blur(0px);
            }
            80% { 
                opacity: 0.9;
                filter: blur(0px);
                transform: translateX(20vw) scale(1.05);
            }
            100% { 
                transform: translateX(-100%) scale(1);
                opacity: 0.3;
                filter: blur(2px);
            }
        }

        @keyframes fireMove {
            0% { 
                transform: translateX(100vw);
                text-shadow: 0 0 5px #ff6b6b;
            }
            20% { 
                transform: translateX(80vw) translateY(-5px);
                text-shadow: 0 0 20px #ff6b6b, 0 0 30px #ff6b6b;
            }
            40% { 
                transform: translateX(60vw) translateY(3px);
                text-shadow: 0 0 25px #ff6b6b, 0 0 40px #ff6b6b;
            }
            60% { 
                transform: translateX(40vw) translateY(-3px);
                text-shadow: 0 0 20px #ff6b6b, 0 0 30px #ff6b6b;
            }
            80% { 
                transform: translateX(20vw) translateY(2px);
                text-shadow: 0 0 15px #ff6b6b, 0 0 25px #ff6b6b;
            }
            100% { 
                transform: translateX(-100%);
                text-shadow: 0 0 5px #ff6b6b;
            }
        }

        @keyframes neonMove {
            0% { 
                transform: translateX(100vw);
                box-shadow: 0 0 5px #48dbfb;
            }
            50% { 
                box-shadow: 0 0 20px #48dbfb, 0 0 30px #48dbfb, 0 0 40px #48dbfb;
            }
            100% { 
                transform: translateX(-100%);
                box-shadow: 0 0 5px #48dbfb;
            }
        }

        /* ç”¨æˆ·å¼¹å¹•é«˜äº®æ ·å¼ */
        .danmu.my-danmu {
            background: linear-gradient(45deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8)) !important;
            color: #1a2980 !important;
            font-weight: bold;
            padding: 6px 16px;
            border-radius: 25px;
            border: 3px solid #ff6b6b;
            box-shadow: 
                0 0 20px rgba(255, 107, 107, 0.8),
                0 0 40px rgba(255, 107, 107, 0.6),
                inset 0 0 20px rgba(255,255,255,0.3);
            z-index: 1000;
            animation: myDanmuMove 10s linear forwards;
            font-size: 22px !important;
        }
        
        .danmu.my-danmu::before {
            content: "ğŸ‘¤ ";
            margin-right: 5px;
            filter: drop-shadow(0 0 5px rgba(255,107,107,0.8));
        }
        
        .danmu.my-danmu::after {
            content: " â˜…";
            margin-left: 5px;
            color: #ff6b6b;
            filter: drop-shadow(0 0 5px rgba(255,107,107,0.8));
        }
        
        @keyframes myDanmuMove {
            0% { 
                transform: translateX(100vw) scale(1.3);
                box-shadow: 
                    0 0 30px rgba(255, 107, 107, 1),
                    0 0 60px rgba(255, 107, 107, 0.8);
            }
            20% { 
                transform: translateX(80vw) scale(1.2);
            }
            50% { 
                transform: translateX(50vw) scale(1.1);
            }
            80% { 
                transform: translateX(20vw) scale(1.05);
            }
            100% { 
                transform: translateX(-100%) scale(1);
            }
        }

        /* ç‚¹èµå®¹å™¨æ ·å¼ */
        .like-container {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            z-index: 1001;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .danmu:hover .like-container {
            opacity: 1 !important;
            transform: scale(1.1);
        }

        .danmu.paused .like-container {
            opacity: 1 !important;
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.2);
        }

        .danmu.paused .like-count {
            color: #333;
            font-weight: bold;
        }

        /* ç‚¹èµæŒ‰é’®æ ·å¼ */
        .like-btn {
            cursor: pointer;
            margin-right: 5px;
            opacity: 0.8;
            transition: all 0.3s ease;
            user-select: none;
            display: inline-block;
            pointer-events: auto;
            font-size: 14px;
        }
        
        .like-btn:hover {
            opacity: 1;
            transform: scale(1.4);
        }
        
        .like-btn.liked {
            color: #ff6b6b !important;
            opacity: 1;
            filter: drop-shadow(0 0 5px rgba(255,107,107,0.8));
        }
        
        .like-count {
            color: white;
            font-size: 12px;
            min-width: 15px;
            text-align: center;
            display: inline-block;
            pointer-events: none;
            font-weight: bold;
        }
        
        /* ç‚¹èµåŠ¨ç”» */
        @keyframes likePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.8); }
            100% { transform: scale(1); }
        }
        
        .like-pop {
            animation: likePop 0.5s ease-out;
        }

        /* æš‚åœçŠ¶æ€æ ·å¼ */
        .danmu.paused {
            animation-play-state: paused !important;
            background: linear-gradient(45deg, rgba(255,255,255,0.98), rgba(255,255,255,0.9)) !important;
            color: #222 !important;
            box-shadow: 
                0 0 25px rgba(255, 107, 107, 0.9),
                0 0 50px rgba(255, 107, 107, 0.7),
                inset 0 0 30px rgba(255,255,255,0.4);
            z-index: 10000 !important;
            transform: scale(1.1);
            transition: all 0.4s ease;
            padding: 6px 16px;
            border-radius: 25px;
            border: 3px solid #ff6b6b;
        }
        
        .danmu.paused::before {
            content: "â¸ï¸ ";
            margin-right: 5px;
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.5));
        }

        /* å¾ªç¯æ’­æ”¾æŒ‰é’® */
        #loop-btn {
            padding: 10px 25px;
            background: linear-gradient(45deg, #ff6b6b, #e74c3c);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        
        #loop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.6);
        }
        
        #loop-btn.playing {
            background: linear-gradient(45deg, #1dd1a1, #2ecc71);
            box-shadow: 0 4px 15px rgba(29,209,161,0.4);
        }

        /* ç‰¹æ•ˆè¯´æ˜ */
        .effects-info {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 8px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="status" id="status">åˆå§‹åŒ–ä¸­...</div>
    <div class="stats" id="stats">
        ä»Šæ—¥: <span id="today-count">0</span> | 
        æ€»è®¡: <span id="total-count">0</span>
    </div>

    <div id="danmu-container">
        <div class="loading" id="loading">âœ¨ å‘é€ä½ çš„ç‹¬å±å¼¹å¹•å§</div>
    </div>

    <div class="input-area">
        <select id="danmu-type">
            <option value="trouble">ğŸ˜” çƒ¦æ¼</option>
            <option value="wish">âœ¨ æ„¿æœ›</option>
        </select>
        <input type="text" id="danmu-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯...">
        <button id="send-btn">å‘å°„å¼¹å¹•</button>
        <button id="loop-btn">â¹ï¸ åœæ­¢å¾ªç¯</button>
    </div>

    <div class="effects-info">
        ğŸ’« 30%çš„å¼¹å¹•ä¼šè·å¾—è¶…é…·ç‚«ç‰¹æ•ˆï¼ğŸ‘¤ ä½ çš„å¼¹å¹•ä¼šé«˜äº®æ˜¾ç¤ºï¼<br>
        ğŸ’– ç‚¹å‡»å¼¹å¹•æš‚åœï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºç‚¹èµæŒ‰é’®ï¼
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.8.0/dist/umd/supabase.min.js"></script>
    <script>
        // é…ç½®ä¿¡æ¯
        const SUPABASE_URL = 'https://qygwuooeuemjgyaceckv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5Z3d1b29ldWVtamd5YWNlY2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1ODQ1NzksImV4cCI6MjA3ODE2MDU3OX0.c0_Cc1mn4lym-BssaqseCJj_mkjoQqViPYaCMpnroZI';
        
        // åˆå§‹åŒ–Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // è·å–DOMå…ƒç´ 
        const statusEl = document.getElementById('status');
        const loadingEl = document.getElementById('loading');
        const container = document.getElementById('danmu-container');
        const input = document.getElementById('danmu-input');
        const sendBtn = document.getElementById('send-btn');
        const typeSelect = document.getElementById('danmu-type');
        const statsEl = document.getElementById('stats');
        const loopBtn = document.getElementById('loop-btn');
        
        // å…¨å±€å˜é‡
        let allDanmus = [];
        let isLoopPlaying = true; // é»˜è®¤å¼€å¯å¾ªç¯æ’­æ”¾
        let loopInterval = null;
        const LOOP_INTERVAL = 800;
        let lastSendTime = 0;
        const likedDanmus = new Map();
        let currentlyPausedDanmu = null;

        // æ•æ„Ÿè¯è¿‡æ»¤
        const sensitiveWords = ['å¹¿å‘Š', 'èµŒåš', 'è¯ˆéª—', 'è„è¯', 'ç§ä¿¡', 'vx', 'QQ'];
        function filterContent(text) {
            let result = text;
            sensitiveWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                result = result.replace(regex, '***');
            });
            return result;
        }
        
        // å‘é€é¢‘ç‡é™åˆ¶
        function checkSendFrequency() {
            const now = Date.now();
            if (now - lastSendTime < 3000) {
                alert('å‘é€å¤ªå¿«äº†ï¼Œè¯·ä¼‘æ¯3ç§’å†å‘ï½');
                return false;
            }
            lastSendTime = now;
            return true;
        }
        
        // æˆåŠŸåé¦ˆ
        function showSuccessMessage() {
            const messages = ['ğŸ‰ å‘å°„æˆåŠŸï¼', 'âœ¨ æ„¿æœ›å·²é€è¾¾ï¼', 'ğŸ’« çƒ¦æ¼å·²é‡Šæ”¾ï¼', 'ğŸŒŸ å¿ƒå£°å·²è¢«å¬è§ï¼'];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            
            const feedback = document.createElement('div');
            feedback.textContent = randomMsg;
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
                color: white;
                padding: 15px 30px;
                border-radius: 30px;
                z-index: 1000;
                font-weight: bold;
                font-size: 16px;
                animation: fadeScale 2s ease-out forwards;
                box-shadow: 0 0 30px rgba(255,107,107,0.6);
            `;
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 2000);
        }
        
        // ç»Ÿè®¡åŠŸèƒ½
        async function updateStats() {
            try {
                const { data } = await supabase
                    .from('danmu')
                    .select('created_at');
                
                if (data) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayCount = data.filter(item => 
                        item.created_at && item.created_at.startsWith(today)
                    ).length;
                    
                    document.getElementById('today-count').textContent = todayCount;
                    document.getElementById('total-count').textContent = data.length;
                }
            } catch (error) {
                console.log('ç»Ÿè®¡æ›´æ–°å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#ff6b6b' : '#4CAF50';
        }

        // è·å–éšæœºç‰¹æ•ˆ - å¢å¼ºç‰ˆï¼ˆæ›´å¤šç‰¹æ•ˆï¼‰
        function getRandomEffect() {
            const effects = [
                'special',    // ç¼©æ”¾æ—‹è½¬ç‰¹æ•ˆ
                'rainbow',    // å½©è™¹æ¸å˜
                'shake',      // å¼ºçƒˆæŠ–åŠ¨
                'bounce',     // å¤§å¹…å¼¹è·³
                'glowing',    // è¶…å¼ºå‘å…‰
                'ghost',      // å¹½çµæ•ˆæœ
                'fire',       // ç«ç„°æ•ˆæœ
                'neon'        // éœ“è™¹ç¯æ•ˆæœ
            ];
            // 50%çš„æ¦‚ç‡è·å¾—ç‰¹æ•ˆ
            return Math.random() < 0.5 ? effects[Math.floor(Math.random() * effects.length)] : null;
        }

        // åˆ›å»ºå¼¹å¹•
        function createDanmu(text, type, isMyDanmu = false, danmuId = null) {
            const danmu = document.createElement('div');
            danmu.className = `danmu ${type}`;
            danmu.textContent = text;
            
            if (isMyDanmu) {
                danmu.classList.add('my-danmu');
            } else {
                const effect = getRandomEffect();
                if (effect) {
                    danmu.classList.add(effect);
                }
            }
            
            // è®¾ç½®ä½ç½®ï¼ˆé˜²é‡å ï¼‰
            let top;
            let attempts = 0;
            const maxAttempts = 15;
            
            do {
                top = Math.random() * 75 + 5;
                attempts++;
            } while (isPositionOverlap(top) && attempts < maxAttempts);
            
            danmu.style.top = top + '%';
            
            container.appendChild(danmu);
            
            // ä¸ºéç”¨æˆ·å¼¹å¹•æ·»åŠ ç‚¹èµæŒ‰é’®
            if (!isMyDanmu && danmuId) {
                addLikeButton(danmu, danmuId);
            }

            // ç‚¹å‡»æš‚åœåŠŸèƒ½
            danmu.addEventListener('click', function(e) {
                if (e.target.closest('.like-container') || e.target.classList.contains('like-btn')) {
                    return;
                }
                
                if (this === currentlyPausedDanmu) {
                    resumeDanmu(this);
                    currentlyPausedDanmu = null;
                    updateStatus('å¼¹å¹•å·²æ¢å¤');
                } else {
                    if (currentlyPausedDanmu) {
                        resumeDanmu(currentlyPausedDanmu);
                    }
                    pauseDanmu(this);
                    currentlyPausedDanmu = this;
                }
            });

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                if (danmu.parentNode && danmu !== currentlyPausedDanmu) {
                    danmu.remove();
                }
            }, isMyDanmu ? 10000 : 14000);
            
            return danmu;
        }

        // æ£€æŸ¥ä½ç½®æ˜¯å¦é‡å 
        function isPositionOverlap(top) {
            const existingDanmus = document.querySelectorAll('.danmu');
            const TOLERANCE = 6; // å‡å°‘å®¹å¿åº¦ï¼Œè®©å¼¹å¹•æ›´å¯†é›†
            
            for (let existing of existingDanmus) {
                const existingTop = parseFloat(existing.style.top);
                if (Math.abs(existingTop - top) < TOLERANCE) {
                    return true;
                }
            }
            return false;
        }

        // æš‚åœå¼¹å¹•
        function pauseDanmu(danmuElement) {
            danmuElement.classList.add('paused');
            danmuElement.style.animationPlayState = 'paused';
            updateStatus('å¼¹å¹•å·²æš‚åœï¼Œå¯ä»¥ç‚¹èµäº†');
        }

        // æ¢å¤å¼¹å¹•
        function resumeDanmu(danmuElement) {
            danmuElement.classList.remove('paused');
            danmuElement.style.animationPlayState = 'running';
        }

        // ç‚¹èµæŒ‰é’®åŠŸèƒ½
        function addLikeButton(danmuElement, danmuId) {
            if (danmuElement.querySelector('.like-container')) return;
            
            const likeContainer = document.createElement('span');
            likeContainer.className = 'like-container';
            
            const likeBtn = document.createElement('span');
            likeBtn.className = 'like-btn';
            likeBtn.innerHTML = 'ğŸ¤';
            likeBtn.title = 'ç‚¹èµ';
            
            const likeCount = document.createElement('span');
            likeCount.className = 'like-count';
            likeCount.textContent = '0';
            
            likeContainer.appendChild(likeBtn);
            likeContainer.appendChild(likeCount);
            danmuElement.appendChild(likeContainer);
            
            // è·å–åˆå§‹ç‚¹èµæ•°
            updateLikeCountFromDB(danmuId, likeCount);
            
            // ç‚¹èµç‚¹å‡»äº‹ä»¶
            likeBtn.addEventListener('click', async function(e) {
                e.stopPropagation();
                e.preventDefault();
                await handleLike(danmuId, likeBtn, likeCount);
            });
        }

        // å¤„ç†ç‚¹èµé€»è¾‘
        async function handleLike(danmuId, likeBtn, likeCount) {
            try {
                const currentCount = parseInt(likeCount.textContent) || 0;
                
                if (likedDanmus.has(danmuId)) {
                    // å–æ¶ˆç‚¹èµ
                    const newCount = Math.max(0, currentCount - 1);
                    
                    const { error } = await supabase
                        .from('danmu')
                        .update({ like_count: newCount })
                        .eq('id', danmuId);
                    
                    if (!error) {
                        likedDanmus.delete(danmuId);
                        updateLikeUI(likeBtn, likeCount, false, newCount);
                        updateStatus('å–æ¶ˆç‚¹èµ');
                    }
                } else {
                    // ç‚¹èµ
                    const newCount = currentCount + 1;
                    
                    const { error } = await supabase
                        .from('danmu')
                        .update({ like_count: newCount })
                        .eq('id', danmuId);
                    
                    if (!error) {
                        likedDanmus.set(danmuId, newCount);
                        updateLikeUI(likeBtn, likeCount, true, newCount);
                        updateStatus('ç‚¹èµæˆåŠŸï¼');
                        
                        likeBtn.classList.add('like-pop');
                        setTimeout(() => likeBtn.classList.remove('like-pop'), 500);
                    }
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                updateStatus('ç‚¹èµå¤±è´¥', true);
            }
        }
        
        // æ›´æ–°ç‚¹èµUI
        function updateLikeUI(likeBtn, likeCount, isLiked, count) {
            likeBtn.innerHTML = isLiked ? 'â¤ï¸' : 'ğŸ¤';
            likeBtn.classList.toggle('liked', isLiked);
            likeCount.textContent = count;
        }
        
        // ä»æ•°æ®åº“è·å–ç‚¹èµæ•°
        async function updateLikeCountFromDB(danmuId, likeCount) {
            try {
                const { data, error } = await supabase
                    .from('danmu')
                    .select('like_count')
                    .eq('id', danmuId)
                    .single();
                
                if (!error && data) {
                    likeCount.textContent = data.like_count || 0;
                }
            } catch (error) {
                likeCount.textContent = '0';
            }
        }

        // åŠ è½½å†å²å¼¹å¹• - ä¿®å¤ï¼šæŒ‰æ—¶é—´å€’åºæ’åˆ—
        async function loadHistoryDanmus() {
            try {
                updateStatus('åŠ è½½å†å²å¼¹å¹•...');
                
                // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰é¢
                const { data, error } = await supabase
                    .from('danmu')
                    .select('*')
                    .order('created_at', { ascending: false }) // æ”¹ä¸ºå€’åº
                    .limit(100);

                if (error) throw error;

                if (loadingEl) loadingEl.remove();
                
                allDanmus = data || [];
                updateStatus(`å·²åŠ è½½ ${data.length} æ¡å¼¹å¹•`);

                // ç«‹å³æ˜¾ç¤ºä¸€äº›åˆå§‹å¼¹å¹•
                showInitialDanmus();

                // è‡ªåŠ¨å¼€å§‹å¾ªç¯æ’­æ”¾
                startLoopPlay();

            } catch (error) {
                updateStatus('åŠ è½½å¤±è´¥: ' + error.message, true);
            }
        }

        // æ˜¾ç¤ºåˆå§‹å¼¹å¹•
        function showInitialDanmus() {
            // ç«‹å³æ˜¾ç¤ºå‰10æ¡æœ€æ–°çš„å¼¹å¹•
            allDanmus.slice(0, 30).forEach((danmu, index) => {
                setTimeout(() => {
                    createDanmu(danmu.text, danmu.type, false, danmu.id);
                }, index * 300); // å¿«é€Ÿè¿ç»­æ˜¾ç¤º
            });
        }

        // å‘é€å¼¹å¹•
        async function sendDanmu() {
            if (!checkSendFrequency()) return;
            
            const rawText = input.value.trim();
            if (!rawText) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }
            
            // è¿‡æ»¤å†…å®¹
            const filteredText = filterContent(rawText);
            const type = typeSelect.value;
            
            try {
                updateStatus('å‘é€ä¸­...');
                
                // ç«‹å³æ˜¾ç¤ºå¼¹å¹•
                createDanmu(filteredText, type, true);
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const { error } = await supabase
                    .from('danmu')
                    .insert([{ text: filteredText, type: type }]);

                if (error) throw error;

                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                showSuccessMessage();
                updateStatus('å‘é€æˆåŠŸï¼');
                input.value = '';
                input.focus();

                // æ›´æ–°ç»Ÿè®¡
                updateStats();

                // å°†æ–°å‘é€çš„å¼¹å¹•æ·»åŠ åˆ°å¾ªç¯æ’­æ”¾åº“ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼‰
                allDanmus.unshift({ 
                    text: filteredText, 
                    type: type,
                    created_at: new Date().toISOString()
                });

            } catch (error) {
                updateStatus('å‘é€å¤±è´¥: ' + error.message, true);
            }
        }

        // å®æ—¶ç›‘å¬æ–°å¼¹å¹•
        function setupRealtimeListener() {
            supabase
                .channel('danmu-channel')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'danmu' 
                    }, 
                    (payload) => {
                        // é¿å…é‡å¤æ˜¾ç¤ºè‡ªå·±åˆšå‘çš„å¼¹å¹•
                        if (payload.new.text !== input.value) {
                            createDanmu(payload.new.text, payload.new.type, false, payload.new.id);
                            updateStatus('æ”¶åˆ°æ–°å¼¹å¹•ï¼');
                            updateStats();
                            // æ–°å¼¹å¹•æ”¾åœ¨æœ€å‰é¢
                            allDanmus.unshift(payload.new);
                        }
                    }
                )
                .subscribe();
        }

        // å¾ªç¯æ’­æ”¾æ§åˆ¶
        function startLoopPlay() {
            if (isLoopPlaying || allDanmus.length === 0) {
                return;
            }
            
            isLoopPlaying = true;
            loopBtn.textContent = 'â¹ï¸ åœæ­¢å¾ªç¯';
            loopBtn.classList.add('playing');
            updateStatus('å¾ªç¯æ’­æ”¾å·²å¼€å¯');
            
            let currentIndex = 0;
            
            // æ¸…é™¤ä¹‹å‰çš„å¾ªç¯
            if (loopInterval) {
                clearInterval(loopInterval);
            }
            
            loopInterval = setInterval(() => {
                if (currentIndex >= allDanmus.length) {
                    currentIndex = 0;
                }
                
                const danmu = allDanmus[currentIndex];
                createDanmu(danmu.text, danmu.type, false, danmu.id);
                currentIndex++;
                
            }, LOOP_INTERVAL);
        }
        
        function stopLoopPlay() {
            isLoopPlaying = false;
            loopBtn.textContent = 'ğŸ” å¼€å¯å¾ªç¯';
            loopBtn.classList.remove('playing');
            updateStatus('å¾ªç¯æ’­æ”¾å·²åœæ­¢');
            
            if (loopInterval) {
                clearInterval(loopInterval);
                loopInterval = null;
            }
        }
        
        function toggleLoopPlay() {
            if (isLoopPlaying) {
                stopLoopPlay();
            } else {
                startLoopPlay();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            updateStatus('ç³»ç»Ÿå¯åŠ¨ä¸­...');
            
            try {
                // åŠ è½½å†å²æ•°æ®
                await loadHistoryDanmus();
                
                // å¼€å¯å®æ—¶ç›‘å¬
                setupRealtimeListener();

                // åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯
                await updateStats();
                
                updateStatus('ç³»ç»Ÿå°±ç»ªï¼');
                
            } catch (error) {
                updateStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, true);
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendDanmu);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendDanmu();
        });
        loopBtn.addEventListener('click', toggleLoopPlay);

        // å¯åŠ¨åº”ç”¨
        initializeApp();
    </script>
</body>
</html>